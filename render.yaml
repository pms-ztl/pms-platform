# Render Blueprint - PMS Platform
# Single service serves both API + Frontend at pms.xzashr.com
# Database: Neon.tech PostgreSQL (external), Cache: Upstash Redis (external)
# Docs: https://render.com/docs/blueprint-spec

services:
  # ---- PMS Platform (API + Frontend) ----
  - type: web
    name: pms-platform
    runtime: node
    region: oregon
    plan: free
    buildCommand: |
      echo "=== Installing dependencies (with devDeps) ===" &&
      NODE_ENV=development npm ci &&
      echo "=== Generating Prisma client ===" &&
      cd packages/database && npx prisma generate && echo "=== Building database package ===" && npm run build && cd ../.. &&
      echo "=== Building core package ===" &&
      cd packages/core && npm run build || true && cd ../.. &&
      echo "=== Building web frontend ===" &&
      cd apps/web && VITE_API_URL=/api/v1 npx vite build && cd ../.. &&
      echo "=== Copying frontend to API ===" &&
      mkdir -p apps/api/frontend-dist &&
      cp -r apps/web/dist/* apps/api/frontend-dist/ &&
      echo "=== Building API ===" &&
      cd apps/api && npm run build && cd ../.. &&
      echo "=== Compiling seed for production ===" &&
      mkdir -p packages/database/prisma/dist &&
      npx esbuild packages/database/prisma/seed.ts --bundle --platform=node --outfile=packages/database/prisma/dist/seed.js --external:@prisma/client --external:bcryptjs --format=cjs &&
      echo "=== Build complete ==="
    startCommand: cd packages/database && npx prisma migrate deploy && cd ../.. && node scripts/seed-if-empty.js && cd apps/api && node dist/index.js
    healthCheckPath: /health
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 10000
      - key: HOST
        value: 0.0.0.0
      # Database: Neon.tech PostgreSQL (set in Render dashboard)
      - key: DATABASE_URL
        sync: false
      - key: DIRECT_URL
        sync: false
      # Cache: Upstash Redis (set in Render dashboard)
      - key: REDIS_URL
        sync: false
      # Secrets (auto-generated on first deploy, never regenerated)
      - key: JWT_SECRET
        generateValue: true
      - key: JWT_EXPIRES_IN
        value: 8h
      - key: JWT_REFRESH_EXPIRES_IN
        value: 7d
      - key: SESSION_SECRET
        generateValue: true
      - key: ENCRYPTION_KEY
        generateValue: true
      - key: MFA_ISSUER
        value: PMS Platform
      - key: CORS_ORIGINS
        value: https://pms.xzashr.com,https://pms-platform.onrender.com
      - key: LOG_LEVEL
        value: info
      - key: VITE_API_URL
        value: /api/v1
      # SMTP Email (set in Render dashboard)
      - key: SMTP_HOST
        value: smtp.gmail.com
      - key: SMTP_PORT
        value: "587"
      - key: SMTP_SECURE
        value: "false"
      - key: SMTP_USER
        sync: false
      - key: SMTP_PASS
        sync: false
      - key: SMTP_FROM
        value: "PMS Platform <aerofyta@gmail.com>"
      # AI API Keys (set in Render dashboard)
      - key: GROQ_API_KEY
        sync: false
      - key: GEMINI_API_KEY
        sync: false

# No databases or redis sections â€” using external Neon.tech + Upstash
